<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIFTY Option Chain Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }
        .dashboard-header { text-align: center; margin-bottom: 20px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 20px; }
        .data-table th, .data-table td { padding: 8px; border: 1px solid #ddd; text-align: right; }
        .data-table th { background-color: #3f51b5; color: white; position: sticky; top: 0; }
        /* Highlighting for In-The-Money (ITM) */
        .itm-call { background-color: #e0f7fa; } /* Light Blue for Call ITM */
        .itm-put { background-color: #fce4ec; } /* Light Pink for Put ITM */
        /* Center column for Strike Price */
        .strike-price { background-color: #ffe0b2; font-weight: bold; text-align: center !important; }
        .text-left { text-align: left !important; }
        #last-updated { font-size: 12px; color: #555; margin-top: 10px; }
        /* Style for the main container to enable horizontal scroll on small screens */
        .table-container { overflow-x: auto; } 
    </style>
</head>
<body>

    <div class="dashboard-header">
        <h1>NIFTY Option Chain (Live)</h1>
        <p>Spot Price: <span id="nifty-spot">Loading...</span> | Current Expiry: <span id="expiry-date">Loading...</span></p>
        <p id="last-updated"></p>
    </div>

    <div class="table-container">
        <table id="option-chain-table" class="data-table">
            <thead>
                <tr>
                    <th colspan="7">CALLS (CE)</th>
                    <th class="strike-price" rowspan="2">Strike Price</th>
                    <th colspan="7">PUTS (PE)</th>
                </tr>
                <tr>
                    <th>OI Change</th>
                    <th>OI</th>
                    <th>Volume</th>
                    <th>IV</th>
                    <th>LTP</th>
                    <th>Bid Price</th>
                    <th>Ask Price</th>
                    <th>Bid Price</th>
                    <th>Ask Price</th>
                    <th>LTP</th>
                    <th>IV</th>
                    <th>Volume</th>
                    <th>OI</th>
                    <th>OI Change</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:5000/api/optionchain'; // Must match your Flask port
        const REFRESH_INTERVAL_MS = 60000; // 60,000 milliseconds = 1 minute

        async function fetchOptionChainData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                renderTable(data);
                document.getElementById('last-updated').textContent = `Last Updated: ${new Date().toLocaleTimeString()} (Next refresh in 60s)`;

            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('nifty-spot').textContent = 'ERROR';
                document.getElementById('last-updated').textContent = `Error fetching data: ${error.message}`;
            }
        }

        function renderTable(data) {
            const tbody = document.querySelector('#option-chain-table tbody');
            tbody.innerHTML = ''; // Clear existing data

            // 1. Get Nifty Spot and Expiry Date
            const records = data.records;
            const underlyingValue = records.underlyingValue ? records.underlyingValue.toFixed(2) : 'N/A';
            const expiryDate = records.expiryDates[0];
            
            document.getElementById('nifty-spot').textContent = underlyingValue;
            document.getElementById('expiry-date').textContent = expiryDate;

            // 2. Filter data for the nearest expiry
            const chainData = records.data.filter(item => item.expiryDate === expiryDate);

            // 3. Render Table Rows
            chainData.forEach(item => {
                const tr = document.createElement('tr');
                const strikePrice = item.strikePrice;
                
                // Determine ITM/OTM class for visual highlighting
                const isITM_CE = strikePrice < underlyingValue;
                const isITM_PE = strikePrice > underlyingValue;

                // --- CALLS (CE) Data ---
                // The API can return an empty object for CE/PE if no trading has happened at that strike
                const CE = item.CE || {}; 
                const PE = item.PE || {};

                tr.innerHTML += `
                    <td class="${isITM_CE ? 'itm-call' : ''}">${(CE.changeinOpenInterest || 0).toLocaleString('en-IN')}</td>
                    <td class="${isITM_CE ? 'itm-call' : ''}">${(CE.openInterest || 0).toLocaleString('en-IN')}</td>
                    <td class="${isITM_CE ? 'itm-call' : ''}">${(CE.totalTradedVolume || 0).toLocaleString('en-IN')}</td>
                    <td class="${isITM_CE ? 'itm-call' : ''}">${(CE.impliedVolatility || 0).toFixed(2)}</td>
                    <td class="${isITM_CE ? 'itm-call' : ''}">${(CE.lastPrice || 0).toFixed(2)}</td>
                    <td class="${isITM_CE ? 'itm-call' : ''}">${(CE.bidprice || 0).toFixed(2)}</td>
                    <td class="${isITM_CE ? 'itm-call' : ''}">${(CE.askPrice || 0).toFixed(2)}</td>
                    
                    <td class="strike-price">${strikePrice.toLocaleString('en-IN')}</td>
                    
                    <td class="${isITM_PE ? 'itm-put' : ''}">${(PE.bidprice || 0).toFixed(2)}</td>
                    <td class="${isITM_PE ? 'itm-put' : ''}">${(PE.askPrice || 0).toFixed(2)}</td>
                    <td class="${isITM_PE ? 'itm-put' : ''}">${(PE.lastPrice || 0).toFixed(2)}</td>
                    <td class="${isITM_PE ? 'itm-put' : ''}">${(PE.impliedVolatility || 0).toFixed(2)}</td>
                    <td class="${isITM_PE ? 'itm-put' : ''}">${(PE.totalTradedVolume || 0).toLocaleString('en-IN')}</td>
                    <td class="${isITM_PE ? 'itm-put' : ''}">${(PE.openInterest || 0).toLocaleString('en-IN')}</td>
                    <td class="${isITM_PE ? 'itm-put' : ''}">${(PE.changeinOpenInterest || 0).toLocaleString('en-IN')}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Initial load and setup the refresh interval
        fetchOptionChainData(); 
        setInterval(fetchOptionChainData, REFRESH_INTERVAL_MS);

    </script>

</body>
</html>
